<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <meta name="theme-color" content="#6366f1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>KI-Sprachassistent</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icons/apple-touch-icon.png" />
  
  <style>
    :root {
      /* Color System */
      --primary-color: #6366f1;
      --primary-hover: #5855eb;
      --primary-light: rgba(99, 102, 241, 0.1);
      --secondary-color: #10b981;
      --secondary-light: rgba(16, 185, 129, 0.1);
      --accent-color: #f59e0b;
      --accent-light: rgba(245, 158, 11, 0.1);
      
      --danger-color: #ef4444;
      --warning-color: #f59e0b;
      --success-color: #10b981;
      
      /* Theme Variables */
      --bg-primary: #0a0a0f;
      --bg-secondary: #151520;
      --bg-tertiary: #1f1f2e;
      --bg-card: rgba(255, 255, 255, 0.03);
      
      --text-primary: #ffffff;
      --text-secondary: #a1a1aa;
      --text-muted: #71717a;
      
      /* Glass Morphism */
      --glass-bg: rgba(255, 255, 255, 0.05);
      --glass-border: rgba(255, 255, 255, 0.08);
      --glass-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      
      /* Shadows & Effects */
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.15);
      --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
      --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.25);
      --shadow-glow: 0 0 40px rgba(99, 102, 241, 0.3);
      
      /* Mobile Spacing */
      --spacing-xs: 0.25rem;
      --spacing-sm: 0.5rem;
      --spacing-md: 1rem;
      --spacing-lg: 1.5rem;
      --spacing-xl: 2rem;
      --spacing-2xl: 3rem;
      
      /* Touch-Friendly Sizes */
      --touch-target: 44px;
      --button-height: 56px;
      --input-height: 48px;
      
      /* Dynamic Variables */
      --safe-area-top: env(safe-area-inset-top);
      --safe-area-bottom: env(safe-area-inset-bottom);
      --safe-area-left: env(safe-area-inset-left);
      --safe-area-right: env(safe-area-inset-right);
      
      /* Animation Variables */
      --animation-speed: 0.3s;
      --animation-easing: cubic-bezier(0.4, 0, 0.2, 1);
      --bounce-easing: cubic-bezier(0.68, -0.55, 0.265, 1.55);

      /* Sidebar */
      --sidebar-width: 400px;
      --sidebar-collapsed-width: 60px;

      /* Avatar States */
      --avatar-idle-glow: 0 0 80px rgba(99, 102, 241, 0.3);
      --avatar-listening-glow: 0 0 120px rgba(16, 185, 129, 0.5);
      --avatar-thinking-glow: 0 0 100px rgba(245, 158, 11, 0.4);
      --avatar-speaking-glow: 0 0 140px rgba(139, 92, 246, 0.6);
      --avatar-error-glow: 0 0 100px rgba(239, 68, 68, 0.5);
      --avatar-happy-glow: 0 0 120px rgba(34, 197, 94, 0.6);
    }

    /* Theme Variants */
    [data-theme="light"] {
      --bg-primary: #f8fafc;
      --bg-secondary: #f1f5f9;
      --bg-tertiary: #e2e8f0;
      --bg-card: rgba(0, 0, 0, 0.03);
      --text-primary: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --glass-bg: rgba(0, 0, 0, 0.05);
      --glass-border: rgba(0, 0, 0, 0.08);
    }

    [data-theme="sci-fi"] {
      --primary-color: #00ffff;
      --secondary-color: #ff00ff;
      --accent-color: #ffff00;
      --bg-primary: #000510;
      --bg-secondary: #001020;
      --avatar-idle-glow: 0 0 80px rgba(0, 255, 255, 0.4);
    }

    [data-theme="nature"] {
      --primary-color: #22c55e;
      --secondary-color: #84cc16;
      --accent-color: #f59e0b;
      --bg-primary: #0a0f0a;
      --bg-secondary: #1a2e1a;
      --avatar-idle-glow: 0 0 80px rgba(34, 197, 94, 0.4);
    }

    [data-theme="high-contrast"] {
      --primary-color: #ffffff;
      --secondary-color: #000000;
      --bg-primary: #000000;
      --bg-secondary: #111111;
      --text-primary: #ffffff;
      --glass-bg: rgba(255, 255, 255, 0.1);
    }

    /* Reset & Base */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    html {
      font-size: 16px;
      scroll-behavior: smooth;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      line-height: 1.6;
      overflow-x: hidden;
      min-height: 100vh;
      min-height: 100dvh;
      position: relative;
      transition: margin-left var(--animation-speed) var(--animation-easing);
      
      /* Mobile optimizations */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      touch-action: manipulation;
    }

    /* Sidebar Open State */
    body.sidebar-open {
      margin-left: var(--sidebar-width);
    }

    /* Background Animation */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: 
        radial-gradient(circle at 25% 25%, var(--primary-light) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, var(--secondary-light) 0%, transparent 50%),
        radial-gradient(circle at 50% 100%, var(--accent-light) 0%, transparent 70%);
      opacity: 0.6;
      z-index: -1;
      will-change: transform;
      animation: backgroundFloat 20s ease-in-out infinite;
    }

    @keyframes backgroundFloat {
      0%, 100% { 
        transform: translate3d(0, 0, 0) scale(1);
      }
      33% { 
        transform: translate3d(-5px, -10px, 0) scale(1.02);
      }
      66% { 
        transform: translate3d(10px, -5px, 0) scale(0.98);
      }
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      width: var(--sidebar-width);
      height: 100vh;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-right: 1px solid var(--glass-border);
      z-index: 1000;
      transform: translateX(-100%);
      transition: transform var(--animation-speed) var(--animation-easing);
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) transparent;
      display: flex;
      flex-direction: column;
    }

    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: transparent;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 3px;
    }

    .sidebar.open {
      transform: translateX(0);
    }

    .sidebar-header {
      padding: var(--spacing-lg);
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
    }

    .sidebar-title {
      font-size: 1.2rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .sidebar-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 1.5rem;
      padding: var(--spacing-sm);
      border-radius: 50%;
      transition: all var(--animation-speed) var(--animation-easing);
    }

    .sidebar-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    /* Sidebar Navigation Tabs */
    .sidebar-nav {
      display: flex;
      background: var(--bg-tertiary);
      border-bottom: 1px solid var(--glass-border);
      overflow-x: auto;
      scrollbar-width: none;
    }

    .sidebar-nav::-webkit-scrollbar {
      display: none;
    }

    .sidebar-nav-item {
      flex: 1;
      min-width: 50px;
      padding: var(--spacing-sm) var(--spacing-xs);
      text-align: center;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--animation-speed) var(--animation-easing);
      font-size: 1.1rem;
      border-bottom: 3px solid transparent;
    }

    .sidebar-nav-item:hover {
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-primary);
    }

    .sidebar-nav-item.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      background: rgba(99, 102, 241, 0.05);
    }

    .sidebar-content {
      flex: 1;
      overflow-y: auto;
    }

    .sidebar-panel {
      display: none;
      padding: var(--spacing-lg);
    }

    .sidebar-panel.active {
      display: block;
    }

    .sidebar-section {
      margin-bottom: var(--spacing-xl);
    }

    .sidebar-section-title {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: var(--spacing-md);
      padding-bottom: var(--spacing-sm);
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
    }

    .sidebar-item {
      display: flex;
      flex-direction: column;
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      margin-bottom: var(--spacing-md);
      transition: all var(--animation-speed) var(--animation-easing);
    }

    .sidebar-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--primary-color);
    }

    .sidebar-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .sidebar-item-label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 0.9rem;
    }

    .sidebar-item-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .sidebar-control {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      flex-wrap: wrap;
    }

    /* Controls in Sidebar */
    .sidebar-toggle {
      position: relative;
      width: 40px;
      height: 20px;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 10px;
      cursor: pointer;
      transition: all var(--animation-speed) var(--animation-easing);
      flex-shrink: 0;
    }

    .sidebar-toggle.active {
      background: var(--primary-color);
      border-color: var(--primary-color);
    }

    .sidebar-toggle::after {
      content: '';
      position: absolute;
      top: 1px;
      left: 1px;
      width: 16px;
      height: 16px;
      background: white;
      border-radius: 50%;
      transition: all var(--animation-speed) var(--animation-easing);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .sidebar-toggle.active::after {
      transform: translateX(20px);
    }

    .sidebar-select,
    .sidebar-input,
    .sidebar-range {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      padding: var(--spacing-sm);
      color: var(--text-primary);
      font-size: 0.9rem;
      width: 100%;
      transition: all var(--animation-speed) var(--animation-easing);
    }

    .sidebar-select:focus,
    .sidebar-input:focus,
    .sidebar-range:focus {
      outline: none;
      border-color: var(--primary-color);
      background: rgba(99, 102, 241, 0.05);
    }

    .sidebar-select option {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .sidebar-range {
      -webkit-appearance: none;
      height: 6px;
      padding: 0;
    }

    .sidebar-range::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .sidebar-range::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--primary-color);
      cursor: pointer;
      border: none;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
    }

    .range-value {
      font-size: 0.8rem;
      color: var(--text-secondary);
      min-width: 50px;
      text-align: right;
    }

    .sidebar-button {
      background: var(--primary-color);
      border: none;
      border-radius: 8px;
      padding: var(--spacing-sm) var(--spacing-md);
      color: white;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--animation-speed) var(--animation-easing);
      white-space: nowrap;
    }

    .sidebar-button:hover {
      background: var(--primary-hover);
      transform: translateY(-1px);
    }

    .sidebar-button.secondary {
      background: var(--glass-bg);
      color: var(--text-primary);
      border: 1px solid var(--glass-border);
    }

    .sidebar-button.secondary:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .sidebar-button.danger {
      background: var(--danger-color);
    }

    .sidebar-button.danger:hover {
      background: #dc2626;
    }

    /* Theme Gallery */
    .theme-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
      gap: var(--spacing-sm);
    }

    .theme-card {
      aspect-ratio: 1;
      border-radius: 8px;
      cursor: pointer;
      transition: all var(--animation-speed) var(--animation-easing);
      position: relative;
      overflow: hidden;
      border: 2px solid transparent;
    }

    .theme-card:hover {
      transform: scale(1.05);
      box-shadow: var(--shadow-md);
    }

    .theme-card.active {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.3);
    }

    .theme-dark { background: linear-gradient(135deg, #0a0a0f, #151520); }
    .theme-light { background: linear-gradient(135deg, #f8fafc, #e2e8f0); }
    .theme-sci-fi { background: linear-gradient(135deg, #000510, #001020); }
    .theme-nature { background: linear-gradient(135deg, #0a0f0a, #1a2e1a); }
    .theme-high-contrast { background: linear-gradient(135deg, #000000, #111111); }

    .theme-name {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: var(--spacing-xs);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 0.7rem;
      text-align: center;
    }

    /* Voice Profile Cards */
    .profile-card {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      padding: var(--spacing-md);
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      cursor: pointer;
      transition: all var(--animation-speed) var(--animation-easing);
      margin-bottom: var(--spacing-sm);
    }

    .profile-card:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: var(--primary-color);
    }

    .profile-card.active {
      border-color: var(--primary-color);
      background: rgba(99, 102, 241, 0.1);
    }

    .profile-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }

    .profile-info h4 {
      font-size: 0.9rem;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .profile-info p {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* Statistics */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: var(--spacing-md);
    }

    .stat-card {
      text-align: center;
      padding: var(--spacing-lg);
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
    }

    .stat-number {
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: var(--spacing-xs);
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    /* Plugin Manager */
    .plugin-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-md);
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      margin-bottom: var(--spacing-sm);
    }

    .plugin-info {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .plugin-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1rem;
    }

    .plugin-details h4 {
      font-size: 0.9rem;
      margin-bottom: 2px;
    }

    .plugin-details p {
      font-size: 0.8rem;
      color: var(--text-secondary);
    }

    .plugin-status {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .plugin-status.active {
      background: rgba(34, 197, 94, 0.2);
      color: #22c55e;
    }

    .plugin-status.inactive {
      background: rgba(107, 114, 128, 0.2);
      color: #6b7280;
    }

    /* Main Layout */
    .app-container {
      min-height: 100vh;
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      padding: var(--safe-area-top) var(--safe-area-right) var(--safe-area-bottom) var(--safe-area-left);
      transition: margin-left var(--animation-speed) var(--animation-easing);
    }

    /* Top Navigation Bar */
    .top-nav {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--glass-border);
      padding: var(--spacing-md);
      display: flex;
      justify-content: space-between;
      align-items: center;
      height: 64px;
    }

    .app-logo {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      font-size: 1.2rem;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .nav-actions {
      display: flex;
      gap: var(--spacing-sm);
    }

    .nav-button {
      width: var(--touch-target);
      height: var(--touch-target);
      border-radius: 50%;
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--animation-speed) var(--animation-easing);
      font-size: 1.2rem;
    }

    .nav-button:hover, .nav-button:active {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(0.95);
    }

    /* Sidebar Toggle Button */
    .sidebar-toggle-btn {
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 50%;
      width: var(--touch-target);
      height: var(--touch-target);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all var(--animation-speed) var(--animation-easing);
      font-size: 1.2rem;
      color: var(--text-primary);
    }

    .sidebar-toggle-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: scale(1.05);
    }

    .sidebar-toggle-btn.active {
      background: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
    }

    /* Main Content Area */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: var(--spacing-lg);
      margin-bottom: 120px;
      overflow-y: auto;
      gap: var(--spacing-md);
    }

    /* Header Section */
    .header-section {
      text-align: center;
      margin-bottom: var(--spacing-lg);
    }

    .main-title {
      font-size: clamp(1.8rem, 5vw, 2.5rem);
      font-weight: 800;
      margin-bottom: var(--spacing-sm);
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .main-subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 400;
    }

    /* Enhanced Avatar Section */
    .avatar-section {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: var(--spacing-lg) 0;
    }

    .avatar-container {
      position: relative;
      cursor: pointer;
      transition: transform var(--animation-speed) var(--animation-easing);
    }

    .avatar-container:hover {
      transform: scale(1.02);
    }

    .avatar {
      width: clamp(480px, 80vw, 720px);
      height: clamp(480px, 80vw, 720px);
      border-radius: 50%;
      background: radial-gradient(circle at center, rgba(255, 255, 255, 0.08) 45%, rgba(255, 255, 255, 0.02) 70%, transparent 100%);
      backdrop-filter: blur(20px);
      border: none;
      position: relative;
      overflow: hidden;
      transition: all 0.5s var(--animation-easing);
      box-shadow: var(--avatar-idle-glow);
      will-change: transform;
    }

    /* Avatar Emotion States */
    .avatar.idle {
      box-shadow: var(--avatar-idle-glow);
      animation: idlePulse 4s ease-in-out infinite;
    }

    .avatar.listening {
      box-shadow: var(--avatar-listening-glow);
      animation: listeningPulse 1.5s ease-in-out infinite;
    }

    .avatar.thinking {
      box-shadow: var(--avatar-thinking-glow);
      animation: thinkingPulse 2s ease-in-out infinite;
    }

    .avatar.speaking {
      box-shadow: var(--avatar-speaking-glow);
      animation: speakingPulse 0.8s ease-in-out infinite;
    }

    .avatar.error {
      box-shadow: var(--avatar-error-glow);
      animation: errorShake 0.5s ease-in-out 3;
    }

    .avatar.happy {
      box-shadow: var(--avatar-happy-glow);
      animation: happyBounce 1s ease-in-out 2;
    }

    @keyframes idlePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.02); }
    }

    @keyframes listeningPulse {
      0%, 100% { transform: scale(1.02); }
      50% { transform: scale(1.08); }
    }

    @keyframes thinkingPulse {
      0%, 100% { transform: scale(1) rotate(0deg); }
      25% { transform: scale(1.05) rotate(1deg); }
      75% { transform: scale(1.05) rotate(-1deg); }
    }

    @keyframes speakingPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    @keyframes errorShake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px) scale(1.02); }
      75% { transform: translateX(10px) scale(1.02); }
    }

    @keyframes happyBounce {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.15) translateY(-10px); }
    }

    /* Voice Visualization Canvas */
    .voice-visualizer {
      position: absolute;
      top: 10%;
      left: 10%;
      width: 80%;
      height: 80%;
      border-radius: 50%;
      opacity: 0;
      transition: opacity var(--animation-speed) ease;
      z-index: 3;
    }

    .voice-visualizer.active {
      opacity: 0.8;
    }

    /* Avatar Styles */
    .avatar.style-minimal .nebel-layer {
      display: none;
    }

    .avatar.style-minimal .avatar-core {
      background: var(--primary-color);
      box-shadow: 0 0 20px var(--primary-color);
    }

    .avatar.style-sci-fi {
      background: radial-gradient(circle at center, rgba(0, 255, 255, 0.1) 45%, rgba(255, 0, 255, 0.05) 70%, transparent 100%);
    }

    .avatar.style-sci-fi .avatar-core {
      background: linear-gradient(135deg, #00ffff, #ff00ff);
      animation: sci-fiGlow 2s ease-in-out infinite alternate;
    }

    .avatar.style-nature {
      background: radial-gradient(circle at center, rgba(34, 197, 94, 0.1) 45%, rgba(132, 204, 22, 0.05) 70%, transparent 100%);
    }

    .avatar.style-nature .avatar-core {
      background: linear-gradient(135deg, #22c55e, #84cc16);
    }

    @keyframes sci-fiGlow {
      0% { 
        box-shadow: 0 0 30px #00ffff;
        transform: translate(-50%, -50%) rotate(0deg);
      }
      100% { 
        box-shadow: 0 0 50px #ff00ff;
        transform: translate(-50%, -50%) rotate(180deg);
      }
    }

    /* Nebel Animation */
    .avatar-nebel {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      overflow: hidden;
    }

    .nebel-layer {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 50%;
      background: radial-gradient(circle, var(--primary-color) 0%, transparent 80%);
      opacity: 0.5;
      filter: blur(20px);
      animation: nebelFlow 6s ease-in-out infinite;
    }

    .nebel-layer:nth-child(1) {
      width: 90%;
      height: 90%;
      animation-delay: 0s;
      background: radial-gradient(circle, var(--primary-color) 0%, transparent 80%);
    }

    .nebel-layer:nth-child(2) {
      width: 70%;
      height: 70%;
      animation-delay: 2s;
      animation-direction: reverse;
      background: radial-gradient(circle, var(--secondary-color) 0%, transparent 80%);
    }

    .nebel-layer:nth-child(3) {
      width: 50%;
      height: 50%;
      animation-delay: 4s;
      background: radial-gradient(circle, var(--accent-color) 0%, transparent 80%);
    }

    @keyframes nebelFlow {
      0%, 100% { 
        transform: translate(-50%, -50%) rotate(0deg) scale(1);
        opacity: 0.4;
      }
      25% { 
        transform: translate(-50%, -50%) rotate(90deg) scale(1.2);
        opacity: 0.8;
      }
      50% { 
        transform: translate(-50%, -50%) rotate(180deg) scale(0.8);
        opacity: 0.3;
      }
      75% { 
        transform: translate(-50%, -50%) rotate(270deg) scale(1.1);
        opacity: 0.6;
      }
    }

    .avatar-core {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 120px;
      height: 120px;
      background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
      border-radius: 50%;
      box-shadow: 0 0 60px rgba(99, 102, 241, 0.8);
      animation: coreGlow 3s ease-in-out infinite alternate;
      cursor: pointer;
      transition: all var(--animation-speed) ease;
    }

    .avatar-core:hover {
      transform: translate(-50%, -50%) scale(1.1);
    }

    @keyframes coreGlow {
      0% { 
        transform: translate(-50%, -50%) scale(1);
        box-shadow: 0 0 30px rgba(99, 102, 241, 0.8);
      }
      100% { 
        transform: translate(-50%, -50%) scale(1.2);
        box-shadow: 0 0 50px rgba(99, 102, 241, 1);
      }
    }

    /* Response Overlay on Avatar */
    .response-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 85%;
      height: 85%;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      pointer-events: none;
    }

    .response-content {
      color: var(--text-primary);
      font-size: clamp(1rem, 2vw, 1.4rem);
      line-height: 1.6;
      text-align: center;
      max-width: 90%;
      word-wrap: break-word;
      background: transparent;
      padding: var(--spacing-lg);
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8);
      opacity: 0;
      transform: scale(0.9);
      transition: all var(--animation-speed) var(--animation-easing);
      max-height: 400px;
      overflow-y: auto;
      scrollbar-width: thin;
      scrollbar-color: var(--primary-color) transparent;
    }

    .response-content::-webkit-scrollbar {
      width: 4px;
    }

    .response-content::-webkit-scrollbar-track {
      background: transparent;
    }

    .response-content::-webkit-scrollbar-thumb {
      background: var(--primary-color);
      border-radius: 2px;
    }

    .response-content.show {
      opacity: 1;
      transform: scale(1);
    }

    .response-empty {
      color: var(--text-secondary);
      font-style: italic;
    }

    /* Processing Animation */
    .processing-animation {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 120%;
      height: 120%;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 5;
    }

    .processing-animation.active {
      opacity: 1;
    }

    .processing-circle {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      background: radial-gradient(circle, var(--primary-color) 0%, rgba(99, 102, 241, 0.3) 50%, rgba(99, 102, 241, 0) 100%);
      filter: blur(40px);
      animation: processingWave 2s ease-in-out infinite;
    }

    .processing-circle:nth-child(2) {
      animation-delay: 0.7s;
      background: radial-gradient(circle, var(--secondary-color) 0%, rgba(16, 185, 129, 0.3) 50%, rgba(16, 185, 129, 0) 100%);
      transform: scale(0.8);
    }

    .processing-circle:nth-child(3) {
      animation-delay: 1.4s;
      background: radial-gradient(circle, var(--accent-color) 0%, rgba(245, 158, 11, 0.3) 50%, rgba(245, 158, 11, 0) 100%);
      transform: scale(0.6);
    }

    @keyframes processingWave {
      0%, 100% { 
        transform: scale(var(--scale, 1)) rotate(0deg);
        opacity: 0.3;
      }
      50% { 
        transform: scale(calc(var(--scale, 1) * 1.5)) rotate(180deg);
        opacity: 0.8;
      }
    }

    /* Bottom Controls */
    .bottom-controls {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border-top: 1px solid var(--glass-border);
      padding: var(--spacing-lg);
      padding-bottom: calc(var(--spacing-lg) + var(--safe-area-bottom));
      z-index: 50;
      transition: margin-left var(--animation-speed) var(--animation-easing);
    }

    body.sidebar-open .bottom-controls {
      margin-left: var(--sidebar-width);
    }

    .input-container {
      display: flex;
      gap: var(--spacing-md);
      align-items: center;
      margin-bottom: var(--spacing-md);
    }

    .text-input {
      flex: 1;
      height: var(--input-height);
      background: var(--glass-bg);
      border: 2px solid var(--glass-border);
      border-radius: 24px;
      padding: 0 var(--spacing-lg);
      font-size: 1rem;
      color: var(--text-primary);
      backdrop-filter: blur(10px);
      transition: all var(--animation-speed) var(--animation-easing);
    }

    .text-input:focus {
      outline: none;
      border-color: var(--primary-color);
      background: rgba(99, 102, 241, 0.05);
      transform: scale(1.02);
    }

    .text-input::placeholder {
      color: var(--text-secondary);
    }

    .action-button {
      width: var(--button-height);
      height: var(--button-height);
      border-radius: 50%;
      border: none;
      background: var(--primary-color);
      color: white;
      font-size: 1.3rem;
      cursor: pointer;
      transition: all var(--animation-speed) var(--bounce-easing);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
    }

    .action-button:hover {
      background: var(--primary-hover);
      transform: scale(1.1);
      box-shadow: var(--shadow-lg);
    }

    .action-button:active {
      transform: scale(0.95);
    }

    .action-button.voice {
      background: var(--secondary-color);
      margin-left: var(--spacing-sm);
    }

    .action-button.voice:hover {
      background: #059669;
    }

    .action-button.recording {
      background: var(--danger-color);
      animation: recordingButtonPulse 1s ease-in-out infinite;
    }

    @keyframes recordingButtonPulse {
      0%, 100% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      50% { 
        transform: scale(1.05);
        box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
      }
    }

    /* Recording Indicator */
    .recording-indicator {
      display: none;
      align-items: center;
      justify-content: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-sm) var(--spacing-md);
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 20px;
      color: var(--danger-color);
      font-size: 0.9rem;
      font-weight: 500;
    }

    .recording-indicator.active {
      display: flex;
      animation: slideUp 0.3s var(--bounce-easing);
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .recording-dot {
      width: 8px;
      height: 8px;
      background: var(--danger-color);
      border-radius: 50%;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0.3; }
    }

    /* Notification System */
    .notification-container {
      position: fixed;
      top: 80px;
      left: var(--spacing-md);
      right: var(--spacing-md);
      z-index: 200;
      pointer-events: none;
      transition: margin-left var(--animation-speed) var(--animation-easing);
    }

    body.sidebar-open .notification-container {
      margin-left: var(--sidebar-width);
    }

    .notification {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: 16px;
      padding: var(--spacing-lg);
      margin-bottom: var(--spacing-md);
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
      box-shadow: var(--shadow-lg);
      transform: translateY(-100px);
      opacity: 0;
      transition: all 0.4s var(--bounce-easing);
      pointer-events: auto;
    }

    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .notification.success {
      border-left: 4px solid var(--success-color);
    }

    .notification.error {
      border-left: 4px solid var(--danger-color);
    }

    .notification.warning {
      border-left: 4px solid var(--warning-color);
    }

    .notification-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .notification-content {
      flex: 1;
    }

    .notification-title {
      font-weight: 600;
      margin-bottom: var(--spacing-xs);
      font-size: 0.95rem;
    }

    .notification-message {
      color: var(--text-secondary);
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .notification-close {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 1.2rem;
      cursor: pointer;
      padding: var(--spacing-xs);
      border-radius: 8px;
      transition: all var(--animation-speed) var(--animation-easing);
    }

    .notification-close:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
    }

    /* Scheduled Actions */
    .action-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--spacing-md);
      background: var(--glass-bg);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      margin-bottom: var(--spacing-sm);
    }

    .action-info {
      display: flex;
      align-items: center;
      gap: var(--spacing-md);
    }

    .action-icon {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1rem;
    }

    .action-time {
      font-size: 0.8rem;
      color: var(--text-secondary);
      background: var(--glass-bg);
      padding: 2px 8px;
      border-radius: 12px;
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      body.sidebar-open {
        margin-left: 0;
      }

      .sidebar {
        width: 100vw;
      }

      .main-content {
        padding: var(--spacing-md);
      }
      
      .main-title {
        font-size: 1.8rem;
      }
      
      .bottom-controls {
        padding: var(--spacing-md);
        padding-bottom: calc(var(--spacing-md) + var(--safe-area-bottom));
      }

      body.sidebar-open .bottom-controls {
        margin-left: 0;
      }

      body.sidebar-open .notification-container {
        margin-left: 0;
      }

      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .theme-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    /* Reduced Motion */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
      
      .avatar.active {
        transform: none;
      }
    }
  </style>
</head>
<body data-theme="dark">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">‚öôÔ∏è Einstellungen</div>
      <button class="sidebar-close" onclick="toggleSidebar()" title="Schlie√üen">√ó</button>
    </div>
    
    <!-- Sidebar Navigation Tabs -->
    <div class="sidebar-nav">
      <button class="sidebar-nav-item active" data-tab="settings" onclick="switchSidebarTab('settings')" title="Audio/TTS">üé§</button>
      <button class="sidebar-nav-item" data-tab="llm" onclick="switchSidebarTab('llm')" title="LLM Settings">üß†</button>
      <button class="sidebar-nav-item" data-tab="profiles" onclick="switchSidebarTab('profiles')" title="Voice Profiles">üéôÔ∏è</button>
      <button class="sidebar-nav-item" data-tab="stats" onclick="switchSidebarTab('stats')" title="Statistics">üìä</button>
      <button class="sidebar-nav-item" data-tab="themes" onclick="switchSidebarTab('themes')" title="Themes">üé®</button>
      <button class="sidebar-nav-item" data-tab="plugins" onclick="switchSidebarTab('plugins')" title="Plugins">üîå</button>
      <button class="sidebar-nav-item" data-tab="actions" onclick="switchSidebarTab('actions')" title="Scheduled">‚è∞</button>
      <button class="sidebar-nav-item" data-tab="advanced" onclick="switchSidebarTab('advanced')" title="Advanced">‚ö°</button>
    </div>
    
    <div class="sidebar-content">
      <!-- Audio/TTS Settings Panel -->
      <div class="sidebar-panel active" id="settingsPanel">
        <!-- Audio Settings -->
        <div class="sidebar-section">
          <div class="sidebar-section-title">üé§ Audio (STT/TTS)</div>
          
          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">STT-Modell</div>
                <div class="sidebar-item-desc">Spracherkennungsmodell ausw√§hlen</div>
              </div>
            </div>
            <div class="sidebar-control">
              <select class="sidebar-select" id="sttModel" onchange="updateSetting('sttModel', this.value)">
                <option value="tiny">Tiny (schnell)</option>
                <option value="base" selected>Base (empfohlen)</option>
                <option value="small">Small (genau)</option>
                <option value="medium">Medium (GPU)</option>
                <option value="large-v2">Large-v2 (GPU)</option>
              </select>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">TTS-Engine</div>
                <div class="sidebar-item-desc">Sprachsynthese-System</div>
              </div>
            </div>
            <div class="sidebar-control">
              <select class="sidebar-select" id="ttsEngine" onchange="updateSetting('ttsEngine', this.value)">
                <option value="zonos">Zonos (beste Qualit√§t)</option>
                <option value="piper" selected>Piper (schnell)</option>
                <option value="kokoro">Kokoro (nat√ºrlich)</option>
              </select>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">TTS-Stimme</div>
                <div class="sidebar-item-desc">Stimme f√ºr Sprachausgabe</div>
              </div>
            </div>
            <div class="sidebar-control">
              <select class="sidebar-select" id="ttsVoice" onchange="updateSetting('ttsVoice', this.value)">
                <option value="de-thorsten-low" selected>Thorsten (Deutsch)</option>
                <option value="en-ljspeech">LJ Speech (English)</option>
                <option value="de-karlsson">Karlsson (Deutsch)</option>
                <option value="en-amy">Amy (English)</option>
                <option value="es-mls_10246">Espa√±ol</option>
                <option value="fr-mls_1840">Fran√ßais</option>
              </select>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">TTS-Geschwindigkeit</div>
                <div class="sidebar-item-desc">Sprechgeschwindigkeit anpassen</div>
              </div>
            </div>
            <div class="sidebar-control">
              <input type="range" class="sidebar-range" id="ttsSpeed" min="0.5" max="2.0" step="0.1" value="1.0" onchange="updateSetting('ttsSpeed', this.value)">
              <span class="range-value" id="ttsSpeedValue">1.0x</span>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Avatar-Stil</div>
                <div class="sidebar-item-desc">Visueller Avatar-Style</div>
              </div>
            </div>
            <div class="sidebar-control">
              <select class="sidebar-select" id="avatarStyle" onchange="updateSetting('avatarStyle', this.value)">
                <option value="default" selected>Standard</option>
                <option value="minimal">Minimal</option>
                <option value="sci-fi">Sci-Fi</option>
                <option value="nature">Natur</option>
              </select>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Voice Visualization</div>
                <div class="sidebar-item-desc">Spektrum-Analyzer w√§hrend Aufnahme</div>
              </div>
              <div class="sidebar-toggle active" id="voiceVisualization" onclick="toggleSetting('voiceVisualization')"></div>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Rauschunterdr√ºckung</div>
                <div class="sidebar-item-desc">Reduziert Hintergrundger√§usche</div>
              </div>
              <div class="sidebar-toggle active" id="noiseSuppression" onclick="toggleSetting('noiseSuppression')"></div>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Echo-Unterdr√ºckung</div>
                <div class="sidebar-item-desc">Unterdr√ºckt Echo und R√ºckkopplungen</div>
              </div>
              <div class="sidebar-toggle active" id="echoCancellation" onclick="toggleSetting('echoCancellation')"></div>
            </div>
          </div>
        </div>

        <!-- Staged TTS Settings -->
        <div class="sidebar-section">
          <div class="sidebar-section-title">üé≠ Staged TTS</div>
          
          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Staged TTS aktivieren</div>
                <div class="sidebar-item-desc">Piper Intro + Zonos Hauptinhalt</div>
              </div>
              <div class="sidebar-toggle active" id="stagedTtsEnabled" onclick="toggleSetting('stagedTtsEnabled')"></div>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Intro-Engine</div>
                <div class="sidebar-item-desc">Engine f√ºr schnelle Antwort</div>
              </div>
            </div>
            <div class="sidebar-control">
              <select class="sidebar-select" id="introEngine" onchange="updateSetting('introEngine', this.value)">
                <option value="auto" selected>Auto</option>
                <option value="piper">Piper</option>
                <option value="zonos">Zonos</option>
                <option value="none">Aus</option>
              </select>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Main-Engine</div>
                <div class="sidebar-item-desc">Engine f√ºr Hauptinhalt</div>
              </div>
            </div>
            <div class="sidebar-control">
              <select class="sidebar-select" id="mainEngine" onchange="updateSetting('mainEngine', this.value)">
                <option value="auto" selected>Auto</option>
                <option value="zonos">Zonos</option>
                <option value="piper">Piper</option>
                <option value="none">Aus</option>
              </select>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Intro-L√§nge</div>
                <div class="sidebar-item-desc">Zeichen f√ºr Piper Intro</div>
              </div>
            </div>
            <div class="sidebar-control">
              <input type="range" class="sidebar-range" id="introLength" min="50" max="200" step="10" value="120" onchange="updateSetting('introLength', this.value)">
              <span class="range-value" id="introLengthValue">120</span>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Crossfade</div>
                <div class="sidebar-item-desc">√úberblendung zwischen Engines</div>
              </div>
            </div>
            <div class="sidebar-control">
              <input type="range" class="sidebar-range" id="crossfadeMs" min="50" max="150" step="10" value="100" onchange="updateSetting('crossfadeMs', this.value)">
              <span class="range-value" id="crossfadeMsValue">100ms</span>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-control">
              <button class="sidebar-button" id="applyTtsPlan" onclick="applyStagedTtsPlan()">
                üìù Plan anwenden
              </button>
              <span id="ttsPlanStatus" class="sidebar-item-desc"></span>
            </div>
          </div>
        </div>

        <!-- Connection Settings -->
        <div class="sidebar-section">
          <div class="sidebar-section-title">üåê Verbindung</div>
          
          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">WebSocket Host</div>
                <div class="sidebar-item-desc">Server-Adresse</div>
              </div>
            </div>
            <div class="sidebar-control">
              <input type="text" class="sidebar-input" id="wsHost" placeholder="127.0.0.1" onchange="updateSetting('wsHost', this.value)">
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">WebSocket Port</div>
                <div class="sidebar-item-desc">Server-Port</div>
              </div>
            </div>
            <div class="sidebar-control">
              <input type="number" class="sidebar-input" id="wsPort" placeholder="48232" onchange="updateSetting('wsPort', this.value)">
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Token</div>
                <div class="sidebar-item-desc">Authentifizierungsschl√ºssel</div>
              </div>
            </div>
            <div class="sidebar-control">
              <input type="text" class="sidebar-input" id="wsToken" placeholder="devsecret" onchange="updateSetting('wsToken', this.value)">
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-control">
              <button class="sidebar-button" onclick="testConnection()">üß™ Verbindung testen</button>
              <span id="connectionStatus" class="sidebar-item-desc"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- LLM Settings Panel -->
      <div class="sidebar-panel" id="llmPanel">
        <div class="sidebar-section">
          <div class="sidebar-section-title">üß† Language Model</div>
          
          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">LLM-Modell</div>
                <div class="sidebar-item-desc">Lokales Sprachmodell ausw√§hlen</div>
              </div>
            </div>
            <div class="sidebar-control">
              <select class="sidebar-select" id="llmModel" onchange="updateSetting('llmModel', this.value)">
                <option value="">Wird geladen...</option>
              </select>
              <button class="sidebar-button secondary" onclick="refreshLlmModels()">üîÑ</button>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Temperatur</div>
                <div class="sidebar-item-desc">Kreativit√§t des Modells</div>
              </div>
            </div>
            <div class="sidebar-control">
              <input type="range" class="sidebar-range" id="llmTemperature" min="0.1" max="2.0" step="0.1" value="0.7" onchange="updateSetting('llmTemperature', this.value)">
              <span class="range-value" id="llmTemperatureValue">0.7</span>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Max Tokens</div>
                <div class="sidebar-item-desc">Maximale Antwortl√§nge</div>
              </div>
            </div>
            <div class="sidebar-control">
              <input type="range" class="sidebar-range" id="llmMaxTokens" min="50" max="1000" step="50" value="256" onchange="updateSetting('llmMaxTokens', this.value)">
              <span class="range-value" id="llmMaxTokensValue">256</span>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">System Prompt</div>
                <div class="sidebar-item-desc">Grundverhalten des Assistenten</div>
              </div>
            </div>
            <div class="sidebar-control">
              <select class="sidebar-select" id="systemPrompt" onchange="updateSetting('systemPrompt', this.value)">
                <option value="default" selected>Standard</option>
                <option value="helpful">Hilfsbereit</option>
                <option value="creative">Kreativ</option>
                <option value="professional">Professionell</option>
                <option value="casual">L√§ssig</option>
                <option value="custom">Benutzerdefiniert</option>
              </select>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Context Length</div>
                <div class="sidebar-item-desc">L√§nge des Gespr√§chskontexts</div>
              </div>
            </div>
            <div class="sidebar-control">
              <input type="range" class="sidebar-range" id="contextLength" min="1000" max="8000" step="500" value="4000" onchange="updateSetting('contextLength', this.value)">
              <span class="range-value" id="contextLengthValue">4000</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Voice Profiles Panel -->
      <div class="sidebar-panel" id="profilesPanel">
        <div class="sidebar-section">
          <div class="sidebar-section-title">üéôÔ∏è Sprach-Profile</div>
          
          <div class="profile-card active" onclick="selectVoiceProfile('default')">
            <div class="profile-avatar">üë§</div>
            <div class="profile-info">
              <h4>Standard</h4>
              <p>Thorsten Deutsch - Neutral</p>
            </div>
          </div>

          <div class="profile-card" onclick="selectVoiceProfile('friendly')">
            <div class="profile-avatar">üòä</div>
            <div class="profile-info">
              <h4>Freundlich</h4>
              <p>Warme, einladende Stimme</p>
            </div>
          </div>

          <div class="profile-card" onclick="selectVoiceProfile('professional')">
            <div class="profile-avatar">üíº</div>
            <div class="profile-info">
              <h4>Professionell</h4>
              <p>Klar und gesch√§ftsm√§√üig</p>
            </div>
          </div>

          <div class="profile-card" onclick="selectVoiceProfile('casual')">
            <div class="profile-avatar">üé≠</div>
            <div class="profile-info">
              <h4>L√§ssig</h4>
              <p>Entspannt und locker</p>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-control">
              <button class="sidebar-button" onclick="createVoiceProfile()">‚ûï Neues Profil</button>
              <button class="sidebar-button secondary" onclick="testCurrentVoice()">üîä Test</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Usage Statistics Panel -->
      <div class="sidebar-panel" id="statsPanel">
        <div class="sidebar-section">
          <div class="sidebar-section-title">üìä Nutzungsstatistiken</div>
          
          <div class="stats-grid">
            <div class="stat-card">
              <div class="stat-number" id="totalQueriesCount">247</div>
              <div class="stat-label">Anfragen</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="totalTimeSpent">12.5h</div>
              <div class="stat-label">Gesamtzeit</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="avgResponseTime">1.2s</div>
              <div class="stat-label">‚åÄ Antwortzeit</div>
            </div>
            <div class="stat-card">
              <div class="stat-number" id="voiceUsagePercent">68%</div>
              <div class="stat-label">Spracheingabe</div>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Aktivit√§tstrend (7 Tage)</div>
                <div class="sidebar-item-desc">Anfragen pro Tag</div>
              </div>
            </div>
            <div style="height: 60px; background: var(--glass-bg); border-radius: 8px; display: flex; align-items: end; justify-content: space-between; padding: 8px;">
              <div style="width: 8px; height: 20px; background: var(--primary-color); border-radius: 4px;"></div>
              <div style="width: 8px; height: 35px; background: var(--primary-color); border-radius: 4px;"></div>
              <div style="width: 8px; height: 25px; background: var(--primary-color); border-radius: 4px;"></div>
              <div style="width: 8px; height: 40px; background: var(--primary-color); border-radius: 4px;"></div>
              <div style="width: 8px; height: 45px; background: var(--primary-color); border-radius: 4px;"></div>
              <div style="width: 8px; height: 30px; background: var(--primary-color); border-radius: 4px;"></div>
              <div style="width: 8px; height: 50px; background: var(--primary-color); border-radius: 4px;"></div>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-control">
              <button class="sidebar-button secondary" onclick="exportStats()">üìä Daten exportieren</button>
              <button class="sidebar-button danger" onclick="clearStats()">üóëÔ∏è Statistiken l√∂schen</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Theme Gallery Panel -->
      <div class="sidebar-panel" id="themesPanel">
        <div class="sidebar-section">
          <div class="sidebar-section-title">üé® Theme Gallery</div>
          
          <div class="theme-grid">
            <div class="theme-card theme-dark active" onclick="selectTheme('dark')">
              <div class="theme-name">Dark</div>
            </div>
            <div class="theme-card theme-light" onclick="selectTheme('light')">
              <div class="theme-name">Light</div>
            </div>
            <div class="theme-card theme-sci-fi" onclick="selectTheme('sci-fi')">
              <div class="theme-name">Sci-Fi</div>
            </div>
            <div class="theme-card theme-nature" onclick="selectTheme('nature')">
              <div class="theme-name">Nature</div>
            </div>
            <div class="theme-card theme-high-contrast" onclick="selectTheme('high-contrast')">
              <div class="theme-name">High Contrast</div>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Auto Dark Mode</div>
                <div class="sidebar-item-desc">Automatisch bei Sonnenuntergang</div>
              </div>
              <div class="sidebar-toggle" id="autoDarkMode" onclick="toggleSetting('autoDarkMode')"></div>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Avatar anzeigen</div>
                <div class="sidebar-item-desc">Pulsierenden Avatar einblenden</div>
              </div>
              <div class="sidebar-toggle active" id="showAvatar" onclick="toggleSetting('showAvatar')"></div>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Reduzierte Bewegungen</div>
                <div class="sidebar-item-desc">Animationen minimieren</div>
              </div>
              <div class="sidebar-toggle" id="reducedMotion" onclick="toggleSetting('reducedMotion')"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Plugin Manager Panel -->
      <div class="sidebar-panel" id="pluginsPanel">
        <div class="sidebar-section">
          <div class="sidebar-section-title">üîå Plugin Manager</div>
          
          <div class="plugin-item">
            <div class="plugin-info">
              <div class="plugin-icon">üå§Ô∏è</div>
              <div class="plugin-details">
                <h4>Weather Plugin</h4>
                <p>Aktuelle Wetter-Informationen</p>
              </div>
            </div>
            <div class="plugin-status active">Aktiv</div>
          </div>

          <div class="plugin-item">
            <div class="plugin-info">
              <div class="plugin-icon">üìÖ</div>
              <div class="plugin-details">
                <h4>Calendar Integration</h4>
                <p>Termine und Erinnerungen</p>
              </div>
            </div>
            <div class="plugin-status active">Aktiv</div>
          </div>

          <div class="plugin-item">
            <div class="plugin-info">
              <div class="plugin-icon">üéµ</div>
              <div class="plugin-details">
                <h4>Music Control</h4>
                <p>Musik-Player Steuerung</p>
              </div>
            </div>
            <div class="plugin-status inactive">Inaktiv</div>
          </div>

          <div class="plugin-item">
            <div class="plugin-info">
              <div class="plugin-icon">üè†</div>
              <div class="plugin-details">
                <h4>Smart Home</h4>
                <p>IoT-Ger√§te steuern</p>
              </div>
            </div>
            <div class="plugin-status inactive">Inaktiv</div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-control">
              <button class="sidebar-button" onclick="installPlugin()">‚ûï Plugin installieren</button>
              <button class="sidebar-button secondary" onclick="managePlugins()">‚öôÔ∏è Verwalten</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Scheduled Actions Panel -->
      <div class="sidebar-panel" id="actionsPanel">
        <div class="sidebar-section">
          <div class="sidebar-section-title">‚è∞ Geplante Aktionen</div>
          
          <div class="action-item">
            <div class="action-info">
              <div class="action-icon">‚è∞</div>
              <div class="action-details">
                <h4>Meeting Erinnerung</h4>
                <p>Team Standup Meeting</p>
              </div>
            </div>
            <div class="action-time">09:30</div>
          </div>

          <div class="action-item">
            <div class="action-info">
              <div class="action-icon">üîî</div>
              <div class="action-details">
                <h4>Pause Erinnerung</h4>
                <p>15 Minuten Pause</p>
              </div>
            </div>
            <div class="action-time">14:30</div>
          </div>

          <div class="action-item">
            <div class="action-info">
              <div class="action-icon">üìù</div>
              <div class="action-details">
                <h4>Tageszusammenfassung</h4>
                <p>Automatischer Bericht</p>
              </div>
            </div>
            <div class="action-time">18:00</div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-control">
              <button class="sidebar-button" onclick="addScheduledAction()">‚ûï Aktion hinzuf√ºgen</button>
              <button class="sidebar-button secondary" onclick="manageActions()">üìã Alle verwalten</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Advanced Settings Panel -->
      <div class="sidebar-panel" id="advancedPanel">
        <div class="sidebar-section">
          <div class="sidebar-section-title">‚ö° Erweiterte Einstellungen</div>
          
          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Debug-Modus</div>
                <div class="sidebar-item-desc">Erweiterte Konsolen-Ausgabe</div>
              </div>
              <div class="sidebar-toggle" id="debugMode" onclick="toggleSetting('debugMode')"></div>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Performance-Metriken</div>
                <div class="sidebar-item-desc">Performance-Statistiken anzeigen</div>
              </div>
              <div class="sidebar-toggle" id="performanceMetrics" onclick="toggleSetting('performanceMetrics')"></div>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Auto-Reconnect</div>
                <div class="sidebar-item-desc">Automatische Wiederverbindung</div>
              </div>
              <div class="sidebar-toggle active" id="autoReconnect" onclick="toggleSetting('autoReconnect')"></div>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Verbindungstimeout</div>
                <div class="sidebar-item-desc">Zeit bis zum Verbindungsabbruch</div>
              </div>
            </div>
            <div class="sidebar-control">
              <select class="sidebar-select" id="connectionTimeout" onchange="updateSetting('connectionTimeout', this.value)">
                <option value="3000" selected>3 Sekunden</option>
                <option value="5000">5 Sekunden</option>
                <option value="10000">10 Sekunden</option>
                <option value="15000">15 Sekunden</option>
              </select>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-item-header">
              <div>
                <div class="sidebar-item-label">Log Level</div>
                <div class="sidebar-item-desc">Detailgrad der Protokollierung</div>
              </div>
            </div>
            <div class="sidebar-control">
              <select class="sidebar-select" id="logLevel" onchange="updateSetting('logLevel', this.value)">
                <option value="error">Error</option>
                <option value="warn">Warning</option>
                <option value="info" selected>Info</option>
                <option value="debug">Debug</option>
                <option value="trace">Trace</option>
              </select>
            </div>
          </div>

          <div class="sidebar-item">
            <div class="sidebar-control">
              <button class="sidebar-button secondary" onclick="clearCache()">
                üóëÔ∏è Cache leeren
              </button>
              <button class="sidebar-button danger" onclick="resetAllSettings()">
                üîÑ Zur√ºcksetzen
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="app-container">
    <!-- Top Navigation -->
    <nav class="top-nav">
      <div class="app-logo">
        <span>ü§ñ</span>
        <span>KI-Assistent</span>
      </div>
      <div class="nav-actions">
        <button class="sidebar-toggle-btn" id="sidebarToggle" onclick="toggleSidebar()" title="Einstellungen">
          ‚öôÔ∏è
        </button>
        <button class="nav-button" id="themeToggle" title="Theme wechseln">
          ‚òÄÔ∏è
        </button>
        <button class="nav-button" id="infoBtn" title="Information">
          ‚ÑπÔ∏è
        </button>
      </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Header Section -->
      <section class="header-section">
        <h1 class="main-title">KI-Sprachassistent</h1>
        <p class="main-subtitle">Sprechen Sie mit Ihrem intelligenten Assistenten</p>
      </section>

      <!-- Enhanced Avatar Section with Click Interactions -->
      <section class="avatar-section">
        <div class="avatar-container" onclick="handleAvatarClick()">
          <div class="avatar idle style-default" id="avatar">
            <!-- Voice Visualization Canvas -->
            <canvas class="voice-visualizer" id="voiceCanvas" width="400" height="400"></canvas>
            
            <div class="avatar-nebel">
              <div class="nebel-layer"></div>
              <div class="nebel-layer"></div>
              <div class="nebel-layer"></div>
            </div>
            <div class="avatar-core" title="Klicken f√ºr Interaktion"></div>
            
            <!-- Processing Animation -->
            <div class="processing-animation" id="processingAnimation">
              <div class="processing-circle" style="--scale: 1"></div>
              <div class="processing-circle" style="--scale: 0.8"></div>
              <div class="processing-circle" style="--scale: 0.6"></div>
            </div>
            
            <!-- Response Overlay -->
            <div class="response-overlay">
              <div class="response-content" id="responseContent">
                <div class="response-empty">Ihre Antwort erscheint hier...</div>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <!-- Bottom Controls -->
    <div class="bottom-controls">
      <!-- Recording Indicator -->
      <div class="recording-indicator" id="recordingIndicator">
        <div class="recording-dot"></div>
        <span>Aufnahme l√§uft... <span id="recordingTime">0s</span></span>
      </div>

      <!-- Input Container -->
      <div class="input-container">
        <input
          type="text"
          id="textInput"
          class="text-input"
          placeholder="Fragen Sie mich etwas..."
          autocomplete="off"
          autocorrect="off"
          autocapitalize="sentences"
        />
        <button onclick="sendText()" class="action-button" id="sendBtn" title="Senden">
          ‚û§
        </button>
        <button onclick="toggleRecording()" class="action-button voice" id="voiceBtn" title="Spracheingabe">
          <span id="voiceIcon">üé§</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div class="notification-container" id="notificationContainer"></div>

  <!-- Load core components -->
  <script src="core/ws-utils.js"></script>
  <script src="core/AudioStreamer.js"></script>
  <script src="core/VoiceAssistantCore.js"></script>

  <script>
    // Global State
    let voiceAssistant = null;
    let ws = null;
    let isRecording = false;
    let mediaRecorder;
    let recordingTimer;
    let recordingStartTime;
    let sidebarOpen = false;
    let currentSidebarTab = 'settings';
    let audioContext = null;
    let voiceAnalyzer = null;
    let voiceCanvas = null;
    let voiceCanvasContext = null;
    let animationId = null;

    // Usage Statistics
    let usageStats = {
      totalQueries: parseInt(localStorage.getItem('va.stats.totalQueries') || '0'),
      totalTimeSpent: parseInt(localStorage.getItem('va.stats.totalTimeSpent') || '0'),
      voiceQueries: parseInt(localStorage.getItem('va.stats.voiceQueries') || '0'),
      textQueries: parseInt(localStorage.getItem('va.stats.textQueries') || '0'),
      sessionStart: Date.now(),
      dailyActivity: JSON.parse(localStorage.getItem('va.stats.dailyActivity') || '[]')
    };

    // Enhanced Settings Configuration with all missing settings from version1
    let settings = {
      // Audio Settings
      sttModel: localStorage.getItem('va.settings.sttModel') || 'base',
      ttsEngine: localStorage.getItem('va.settings.ttsEngine') || 'piper',
      ttsVoice: localStorage.getItem('va.settings.ttsVoice') || 'de-thorsten-low',
      ttsSpeed: parseFloat(localStorage.getItem('va.settings.ttsSpeed') || '1.0'),
      noiseSuppression: localStorage.getItem('va.settings.noiseSuppression') !== 'false',
      echoCancellation: localStorage.getItem('va.settings.echoCancellation') !== 'false',
      voiceVisualization: localStorage.getItem('va.settings.voiceVisualization') !== 'false',
      
      // Staged TTS Settings (from version1)
      stagedTtsEnabled: localStorage.getItem('va.settings.stagedTtsEnabled') !== 'false',
      introEngine: localStorage.getItem('va.settings.introEngine') || 'auto',
      mainEngine: localStorage.getItem('va.settings.mainEngine') || 'auto',
      introLength: parseInt(localStorage.getItem('va.settings.introLength') || '120'),
      crossfadeMs: parseInt(localStorage.getItem('va.settings.crossfadeMs') || '100'),
      
      // LLM Settings (from version1)
      llmModel: localStorage.getItem('va.settings.llmModel') || '',
      llmTemperature: parseFloat(localStorage.getItem('va.settings.llmTemperature') || '0.7'),
      llmMaxTokens: parseInt(localStorage.getItem('va.settings.llmMaxTokens') || '256'),
      systemPrompt: localStorage.getItem('va.settings.systemPrompt') || 'default',
      contextLength: parseInt(localStorage.getItem('va.settings.contextLength') || '4000'),
      
      // Avatar Settings
      avatarStyle: localStorage.getItem('va.settings.avatarStyle') || 'default',
      
      // Connection Settings
      wsHost: localStorage.getItem('va.settings.wsHost') || localStorage.getItem('wsHost') || '127.0.0.1',
      wsPort: localStorage.getItem('va.settings.wsPort') || localStorage.getItem('wsPort') || '48232',
      wsToken: localStorage.getItem('va.settings.wsToken') || localStorage.getItem('wsToken') || 'devsecret',
      
      // Appearance Settings
      theme: localStorage.getItem('va.settings.theme') || 'dark',
      autoDarkMode: localStorage.getItem('va.settings.autoDarkMode') === 'true',
      notifications: localStorage.getItem('va.settings.notifications') !== 'false',
      showAvatar: localStorage.getItem('va.settings.showAvatar') !== 'false',
      showNebula: localStorage.getItem('va.settings.showNebula') !== 'false',
      reducedMotion: localStorage.getItem('va.settings.reducedMotion') === 'true',
      
      // Voice Profiles
      currentVoiceProfile: localStorage.getItem('va.settings.currentVoiceProfile') || 'default',
      
      // Advanced Settings (from version1)
      debugMode: localStorage.getItem('va.settings.debugMode') === 'true',
      performanceMetrics: localStorage.getItem('va.settings.performanceMetrics') === 'true',
      autoReconnect: localStorage.getItem('va.settings.autoReconnect') !== 'false',
      connectionTimeout: parseInt(localStorage.getItem('va.settings.connectionTimeout') || '3000'),
      logLevel: localStorage.getItem('va.settings.logLevel') || 'info'
    };

    // Avatar Emotion System
    const AvatarEmotions = {
      setEmotion: function(emotion) {
        const avatar = document.getElementById('avatar');
        // Remove all emotion classes
        avatar.classList.remove('idle', 'listening', 'thinking', 'speaking', 'error', 'happy');
        // Add new emotion
        avatar.classList.add(emotion);
        
        // Update stats
        updateUsageStats('emotion', emotion);
      },
      
      idle: () => AvatarEmotions.setEmotion('idle'),
      listening: () => AvatarEmotions.setEmotion('listening'),
      thinking: () => AvatarEmotions.setEmotion('thinking'),
      speaking: () => AvatarEmotions.setEmotion('speaking'),
      error: () => AvatarEmotions.setEmotion('error'),
      happy: () => AvatarEmotions.setEmotion('happy')
    };

    // Voice Visualization System
    const VoiceVisualizer = {
      init: function() {
        voiceCanvas = document.getElementById('voiceCanvas');
        voiceCanvasContext = voiceCanvas.getContext('2d');
        
        if (audioContext && settings.voiceVisualization) {
          this.setupAnalyzer();
        }
      },
      
      setupAnalyzer: function() {
        if (!audioContext) return;
        
        voiceAnalyzer = audioContext.createAnalyser();
        voiceAnalyzer.fftSize = 256;
        voiceAnalyzer.smoothingTimeConstant = 0.8;
      },
      
      start: function(stream) {
        if (!voiceAnalyzer || !stream) return;
        
        const source = audioContext.createMediaStreamSource(stream);
        source.connect(voiceAnalyzer);
        
        voiceCanvas.classList.add('active');
        this.animate();
      },
      
      stop: function() {
        if (animationId) {
          cancelAnimationFrame(animationId);
          animationId = null;
        }
        voiceCanvas.classList.remove('active');
        this.clear();
      },
      
      animate: function() {
        if (!voiceAnalyzer) return;
        
        const dataArray = new Uint8Array(voiceAnalyzer.frequencyBinCount);
        voiceAnalyzer.getByteFrequencyData(dataArray);
        
        this.draw(dataArray);
        animationId = requestAnimationFrame(() => this.animate());
      },
      
      draw: function(dataArray) {
        const canvas = voiceCanvas;
        const ctx = voiceCanvasContext;
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;
        const radius = Math.min(centerX, centerY) - 20;
        
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw spectrum as circular bars
        const barCount = dataArray.length / 2;
        const angleStep = (2 * Math.PI) / barCount;
        
        for (let i = 0; i < barCount; i++) {
          const angle = i * angleStep;
          const barHeight = (dataArray[i] / 255) * 60;
          
          const x1 = centerX + Math.cos(angle) * radius;
          const y1 = centerY + Math.sin(angle) * radius;
          const x2 = centerX + Math.cos(angle) * (radius + barHeight);
          const y2 = centerY + Math.sin(angle) * (radius + barHeight);
          
          ctx.beginPath();
          ctx.moveTo(x1, y1);
          ctx.lineTo(x2, y2);
          ctx.strokeStyle = `hsl(${(i / barCount) * 360}, 70%, 60%)`;
          ctx.lineWidth = 3;
          ctx.stroke();
        }
      },
      
      clear: function() {
        if (voiceCanvasContext) {
          voiceCanvasContext.clearRect(0, 0, voiceCanvas.width, voiceCanvas.height);
        }
      }
    };

    // Usage Statistics System
    function updateUsageStats(type, value = 1) {
      switch(type) {
        case 'query':
          usageStats.totalQueries += value;
          localStorage.setItem('va.stats.totalQueries', usageStats.totalQueries);
          break;
        case 'voice':
          usageStats.voiceQueries += value;
          localStorage.setItem('va.stats.voiceQueries', usageStats.voiceQueries);
          break;
        case 'text':
          usageStats.textQueries += value;
          localStorage.setItem('va.stats.textQueries', usageStats.textQueries);
          break;
        case 'time':
          usageStats.totalTimeSpent += value;
          localStorage.setItem('va.stats.totalTimeSpent', usageStats.totalTimeSpent);
          break;
      }
      
      // Update daily activity
      const today = new Date().toDateString();
      let dailyActivity = usageStats.dailyActivity;
      const todayIndex = dailyActivity.findIndex(day => day.date === today);
      
      if (todayIndex >= 0) {
        dailyActivity[todayIndex].queries += (type === 'query' ? value : 0);
      } else {
        dailyActivity.push({ date: today, queries: (type === 'query' ? value : 0) });
      }
      
      // Keep only last 7 days
      if (dailyActivity.length > 7) {
        dailyActivity = dailyActivity.slice(-7);
      }
      
      usageStats.dailyActivity = dailyActivity;
      localStorage.setItem('va.stats.dailyActivity', JSON.stringify(dailyActivity));
      
      // Update UI if stats panel is active
      if (currentSidebarTab === 'stats') {
        updateStatsDisplay();
      }
    }

    function updateStatsDisplay() {
      document.getElementById('totalQueriesCount').textContent = usageStats.totalQueries;
      document.getElementById('totalTimeSpent').textContent = (usageStats.totalTimeSpent / 3600000).toFixed(1) + 'h';
      
      const avgResponseTime = 1.2; // This would come from actual metrics
      document.getElementById('avgResponseTime').textContent = avgResponseTime.toFixed(1) + 's';
      
      const voicePercent = usageStats.totalQueries > 0 
        ? Math.round((usageStats.voiceQueries / usageStats.totalQueries) * 100)
        : 0;
      document.getElementById('voiceUsagePercent').textContent = voicePercent + '%';
    }

    // Initialize App
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Load settings into UI
        loadSettingsIntoUI();
        
        // Apply settings
        applySettings();
        
        // Initialize voice visualization
        VoiceVisualizer.init();
        
        // Initialize WebSocket connection
        initWebSocket();
        
        // Setup event handlers
        setupEventHandlers();
        
        // Update stats display
        updateStatsDisplay();
        
        // Focus input on desktop
        document.getElementById('textInput').focus();
        
        // Set initial avatar emotion
        AvatarEmotions.idle();
        
        console.log('‚úÖ Enhanced Voice Assistant initialized');
        
      } catch (error) {
        console.error('‚ùå Initialization failed:', error);
        showNotification('error', 'Fehler', 'Initialisierung fehlgeschlagen');
        AvatarEmotions.error();
      }
    });

    // Settings Functions
    function loadSettingsIntoUI() {
      // Load settings into form controls
      Object.keys(settings).forEach(key => {
        const element = document.getElementById(key);
        if (element) {
          if (element.type === 'checkbox' || element.classList.contains('sidebar-toggle')) {
            if (element.classList.contains('sidebar-toggle')) {
              element.classList.toggle('active', settings[key]);
            } else {
              element.checked = settings[key];
            }
          } else if (element.type === 'range') {
            element.value = settings[key];
            updateRangeValue(key, settings[key]);
          } else {
            element.value = settings[key];
          }
        }
      });

      // Apply theme
      document.body.setAttribute('data-theme', settings.theme);
      
      // Update theme gallery
      document.querySelectorAll('.theme-card').forEach(card => {
        card.classList.remove('active');
      });
      const activeThemeCard = document.querySelector(`.theme-${settings.theme}`);
      if (activeThemeCard) {
        activeThemeCard.classList.add('active');
      }
      
      // Update voice profile
      updateVoiceProfileUI();
    }

    function updateSetting(key, value) {
      // Convert value to appropriate type
      if (typeof settings[key] === 'boolean') {
        value = value === 'true' || value === true;
      } else if (typeof settings[key] === 'number') {
        value = parseFloat(value) || 0;
      }
      
      settings[key] = value;
      localStorage.setItem(`va.settings.${key}`, value);
      
      // Update range value displays
      const element = document.getElementById(key);
      if (element && element.type === 'range') {
        updateRangeValue(key, value);
      }
      
      // Apply setting immediately
      applySettingLive(key, value);
      
      // Send to backend if connected
      sendSettingToBackend(key, value);
      
      if (settings.notifications && settings.debugMode) {
        showNotification('success', 'Einstellung ge√§ndert', `${key}: ${value}`);
      }
    }

    function toggleSetting(key) {
      const newValue = !settings[key];
      updateSetting(key, newValue);
      
      // Update UI toggle
      const toggle = document.getElementById(key);
      if (toggle && toggle.classList.contains('sidebar-toggle')) {
        toggle.classList.toggle('active', newValue);
      }
    }

    function updateRangeValue(key, value) {
      const valueElement = document.getElementById(key + 'Value');
      if (valueElement) {
        if (key.includes('Speed') || key.includes('Temperature')) {
          valueElement.textContent = `${value}x`;
        } else if (key.includes('Ms') || key.includes('Crossfade')) {
          valueElement.textContent = `${value}ms`;
        } else {
          valueElement.textContent = value;
        }
      }
    }

    function applySettingLive(key, value) {
      switch (key) {
        case 'reducedMotion':
          if (value) {
            document.body.style.setProperty('--animation-speed', '0.01ms');
          } else {
            document.body.style.removeProperty('--animation-speed');
          }
          break;
        case 'showAvatar':
          const avatar = document.getElementById('avatar');
          if (avatar) avatar.style.display = value ? 'block' : 'none';
          break;
        case 'showNebula':
          const nebula = document.querySelector('.avatar-nebel');
          if (nebula) nebula.style.display = value ? 'block' : 'none';
          break;
        case 'avatarStyle':
          updateAvatarStyle(value);
          break;
        case 'theme':
          document.body.setAttribute('data-theme', value);
          break;
        case 'voiceVisualization':
          if (value) {
            VoiceVisualizer.init();
          } else {
            VoiceVisualizer.stop();
          }
          break;
      }
    }

    function applySettings() {
      Object.keys(settings).forEach(key => {
        applySettingLive(key, settings[key]);
      });
    }

    function sendSettingToBackend(key, value) {
      if (!ws || ws.readyState !== WebSocket.OPEN) return;
      
      const message = { timestamp: Date.now() };
      
      if (key.startsWith('stt')) {
        message.type = 'set_stt_options';
        message[key.replace('stt', '').toLowerCase()] = value;
      } else if (key.startsWith('tts')) {
        if (key === 'ttsEngine') {
          message.type = 'switch_tts_engine';
          message.engine = value;
        } else if (key === 'ttsVoice') {
          message.type = 'set_tts_voice';
          message.voice = value;
        } else {
          message.type = 'set_tts_options';
          message[key.replace('tts', '').toLowerCase()] = value;
        }
      } else if (key.startsWith('llm')) {
        if (key === 'llmModel') {
          message.type = 'switch_llm_model';
          message.model = value;
        } else {
          message.type = 'set_llm_options';
          message[key.replace('llm', '').toLowerCase()] = value;
        }
      }
      
      if (message.type) {
        ws.send(JSON.stringify(message));
      }
    }

    // Staged TTS Functions (from version1)
    function applyStagedTtsPlan() {
      const intro = settings.introEngine;
      const main = settings.mainEngine;
      
      const statusEl = document.getElementById('ttsPlanStatus');
      statusEl.textContent = '‚è≥ Anwende Plan...';
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'staged_tts_control',
          action: 'set_plan',
          intro_engine: intro,
          main_engine: main,
          intro_length: settings.introLength,
          crossfade_ms: settings.crossfadeMs
        }));
        
        setTimeout(() => {
          statusEl.textContent = '‚úÖ Plan angewendet';
          setTimeout(() => {
            statusEl.textContent = '';
          }, 3000);
        }, 1000);
      } else {
        statusEl.textContent = '‚ùå Nicht verbunden';
      }
    }

    function refreshLlmModels() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'get_llm_models' }));
        showNotification('info', 'LLM-Modelle', 'Aktualisiere verf√ºgbare Modelle...');
      }
    }

    function populateLlmModels(models, current) {
      const select = document.getElementById('llmModel');
      select.innerHTML = '';
      
      if (models.length === 0) {
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = '(kein Modell)';
        select.appendChild(opt);
        select.value = '';
        select.disabled = true;
        return;
      }
      
      models.forEach(model => {
        const opt = document.createElement('option');
        opt.value = model;
        opt.textContent = model;
        select.appendChild(opt);
      });
      
      select.value = current || models[0] || '';
      select.disabled = false;
      updateSetting('llmModel', select.value);
    }

    // Avatar Functions
    function updateAvatarStyle(style) {
      const avatar = document.getElementById('avatar');
      avatar.classList.remove('style-default', 'style-minimal', 'style-sci-fi', 'style-nature');
      avatar.classList.add(`style-${style}`);
    }

    function handleAvatarClick() {
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
      
      // Happy feedback
      AvatarEmotions.happy();
      setTimeout(() => AvatarEmotions.idle(), 1000);
    }

    // Theme Functions
    function selectTheme(theme) {
      updateSetting('theme', theme);
      
      // Update theme gallery UI
      document.querySelectorAll('.theme-card').forEach(card => {
        card.classList.remove('active');
      });
      const themeCard = document.querySelector(`.theme-${theme}`);
      if (themeCard) {
        themeCard.classList.add('active');
      }
      
      showNotification('success', 'Theme ge√§ndert', `${theme.charAt(0).toUpperCase() + theme.slice(1)} Theme aktiviert`);
    }

    // Voice Profile Functions
    function selectVoiceProfile(profile) {
      updateSetting('currentVoiceProfile', profile);
      updateVoiceProfileUI();
      
      // Apply profile settings
      const profiles = {
        default: { voice: 'de-thorsten-low', speed: 1.0 },
        friendly: { voice: 'de-thorsten-low', speed: 0.9 },
        professional: { voice: 'de-thorsten-low', speed: 1.1 },
        casual: { voice: 'de-thorsten-low', speed: 0.8 }
      };
      
      if (profiles[profile]) {
        updateSetting('ttsVoice', profiles[profile].voice);
        updateSetting('ttsSpeed', profiles[profile].speed);
      }
      
      showNotification('success', 'Sprach-Profil ge√§ndert', `${profile.charAt(0).toUpperCase() + profile.slice(1)} Profil aktiviert`);
    }

    function updateVoiceProfileUI() {
      document.querySelectorAll('.profile-card').forEach(card => {
        card.classList.remove('active');
      });
      
      const activeProfile = document.querySelector(`.profile-card[onclick*="${settings.currentVoiceProfile}"]`);
      if (activeProfile) {
        activeProfile.classList.add('active');
      }
    }

    function createVoiceProfile() {
      const name = prompt('Name f√ºr das neue Sprach-Profil:');
      if (name) {
        showNotification('info', 'Profil erstellt', `Neues Profil "${name}" wurde erstellt`);
        // TODO: Implement profile creation logic
      }
    }

    function testCurrentVoice() {
      const testText = "Hallo! Dies ist ein Test der aktuellen Stimme.";
      if (ws && ws.readyState === WebSocket.OPEN) {
        AvatarEmotions.speaking();
        ws.send(JSON.stringify({ 
          type: "tts_test", 
          content: testText,
          timestamp: Date.now()
        }));
        setTimeout(() => AvatarEmotions.idle(), 3000);
      } else {
        showNotification('error', 'Nicht verbunden', 'Keine Verbindung zum Server');
      }
    }

    // Plugin Functions
    function installPlugin() {
      showNotification('info', 'Plugin-Installation', 'Plugin-Store wird ge√∂ffnet...');
      // TODO: Implement plugin installation
    }

    function managePlugins() {
      showNotification('info', 'Plugin-Verwaltung', 'Plugin-Manager wird ge√∂ffnet...');
      // TODO: Implement plugin management
    }

    // Scheduled Actions Functions
    function addScheduledAction() {
      const action = prompt('Neue geplante Aktion:');
      if (action) {
        showNotification('success', 'Aktion hinzugef√ºgt', `"${action}" wurde zur Zeitplanung hinzugef√ºgt`);
        // TODO: Implement scheduled action logic
      }
    }

    function manageActions() {
      showNotification('info', 'Aktions-Verwaltung', 'Alle geplanten Aktionen werden angezeigt...');
      // TODO: Implement action management
    }

    // Statistics Functions
    function exportStats() {
      const data = {
        stats: usageStats,
        exportDate: new Date().toISOString(),
        version: '2.1.0'
      };
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'voice-assistant-stats.json';
      a.click();
      URL.revokeObjectURL(url);
      
      showNotification('success', 'Export abgeschlossen', 'Statistiken wurden exportiert');
    }

    function clearStats() {
      if (confirm('Alle Statistiken l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
        usageStats = {
          totalQueries: 0,
          totalTimeSpent: 0,
          voiceQueries: 0,
          textQueries: 0,
          sessionStart: Date.now(),
          dailyActivity: []
        };
        
        // Clear localStorage
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('va.stats.')) {
            localStorage.removeItem(key);
          }
        });
        
        updateStatsDisplay();
        showNotification('success', 'Statistiken gel√∂scht', 'Alle Nutzungsdaten wurden entfernt');
      }
    }

    function testConnection() {
      const statusEl = document.getElementById('connectionStatus');
      statusEl.textContent = 'Teste...';
      
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));
        setTimeout(() => {
          statusEl.textContent = '‚úÖ Verbunden';
          setTimeout(() => statusEl.textContent = '', 3000);
        }, 500);
      } else {
        statusEl.textContent = '‚ùå Nicht verbunden';
        setTimeout(() => statusEl.textContent = '', 3000);
      }
    }

    function clearCache() {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({ type: 'clear_cache' }));
      }
      showNotification('success', 'Cache geleert', 'Alle tempor√§ren Daten wurden entfernt');
    }

    function resetAllSettings() {
      if (confirm('Alle Einstellungen zur√ºcksetzen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
        // Clear all settings from localStorage
        Object.keys(localStorage).forEach(key => {
          if (key.startsWith('va.settings.')) {
            localStorage.removeItem(key);
          }
        });
        
        // Reset settings object to defaults
        settings = {
          sttModel: 'base',
          ttsEngine: 'piper',
          ttsVoice: 'de-thorsten-low',
          ttsSpeed: 1.0,
          noiseSuppression: true,
          echoCancellation: true,
          voiceVisualization: true,
          stagedTtsEnabled: true,
          introEngine: 'auto',
          mainEngine: 'auto',
          introLength: 120,
          crossfadeMs: 100,
          llmModel: '',
          llmTemperature: 0.7,
          llmMaxTokens: 256,
          systemPrompt: 'default',
          contextLength: 4000,
          avatarStyle: 'default',
          wsHost: '127.0.0.1',
          wsPort: '48232',
          wsToken: 'devsecret',
          theme: 'dark',
          autoDarkMode: false,
          notifications: true,
          showAvatar: true,
          showNebula: true,
          reducedMotion: false,
          currentVoiceProfile: 'default',
          debugMode: false,
          performanceMetrics: false,
          autoReconnect: true,
          connectionTimeout: 3000,
          logLevel: 'info'
        };
        
        loadSettingsIntoUI();
        applySettings();
        showNotification('success', 'Einstellungen zur√ºckgesetzt', 'Alle Werte wurden auf Standard zur√ºckgesetzt');
      }
    }

    // Sidebar Functions
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const toggleBtn = document.getElementById('sidebarToggle');
      
      sidebarOpen = !sidebarOpen;
      
      if (sidebarOpen) {
        sidebar.classList.add('open');
        toggleBtn.classList.add('active');
        document.body.classList.add('sidebar-open');
        
        // Update stats if stats tab is active
        if (currentSidebarTab === 'stats') {
          updateStatsDisplay();
        }
      } else {
        sidebar.classList.remove('open');
        toggleBtn.classList.remove('active');
        document.body.classList.remove('sidebar-open');
      }
    }

    function switchSidebarTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.sidebar-nav-item').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tab) {
          btn.classList.add('active');
        }
      });
      
      // Update tab panels
      document.querySelectorAll('.sidebar-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      document.getElementById(tab + 'Panel').classList.add('active');
      
      currentSidebarTab = tab;
      
      // Update stats if switching to stats tab
      if (tab === 'stats') {
        updateStatsDisplay();
      }
    }

    // WebSocket Functions
    function initWebSocket() {
      try {
        const url = `ws://${settings.wsHost}:${settings.wsPort}/ws`;
        ws = new WebSocket(url);

        ws.onopen = () => {
          console.log('‚úÖ Connected to Voice Assistant');
          showNotification('success', 'Verbunden', 'Erfolgreich mit dem Sprachassistenten verbunden');
          AvatarEmotions.happy();
          setTimeout(() => AvatarEmotions.idle(), 2000);
          
          // Send initial handshake
          ws.send(JSON.stringify({ op: 'hello', stream_id: Date.now() }));
          
          // Request available models
          ws.send(JSON.stringify({ type: 'get_llm_models' }));
        };

        ws.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);
            handleWebSocketMessage(data);
          } catch (e) {
            console.warn('WS parse error:', e);
          }
        };
        
        ws.onclose = () => {
          console.log('‚ùå Connection closed');
          showNotification('error', 'Verbindung getrennt', 'Versuche automatisch zu reconnecten...');
          AvatarEmotions.error();
          
          // Auto-reconnect after 3 seconds if enabled
          if (settings.autoReconnect) {
            setTimeout(() => {
              AvatarEmotions.idle();
              initWebSocket();
            }, settings.connectionTimeout);
          }
        };
        
        ws.onerror = (error) => {
          console.error('WebSocket Error:', error);
          showNotification('error', 'Server nicht erreichbar', 'Bitte √ºberpr√ºfen Sie die Serververbindung');
          AvatarEmotions.error();
        };
        
      } catch (error) {
        console.error('Connection Error:', error);
        showNotification('error', 'Server nicht erreichbar', 'Bitte √ºberpr√ºfen Sie die Konfiguration');
        AvatarEmotions.error();
      }
    }

    function handleWebSocketMessage(data) {

      // --- TTS Audio message (Data-URL) ---
      if ((data.type === 'tts' || data.type === 'audio_tts') && (data.content || data.audio || data.audio_url)) {
        const audioData = data.content || data.audio || data.audio_url;
        if (typeof audioData === 'string' && audioData.startsWith('data:audio')) {
          AvatarEmotions.speaking();
          playDataUrlAudio(audioData);
          if (data.text) { displayResponse(data.text); }
          updateUsageStats('query');
          return;
        }
      }

      hideProcessingAnimation();
      
      if (data.type === 'llm_models') {
        populateLlmModels(data.models, data.current);
      } else if (data.type === 'llm_model_switched') {
        showNotification('info', 'LLM gewechselt', data.model || data.current);
      } else if (data.type === 'response' || data.content) {
        const content = data.content || data.response || '';
        displayResponse(content);
        AvatarEmotions.speaking();
        setTimeout(() => AvatarEmotions.idle(), 3000);
        updateUsageStats('query');
      } else if (data.type === 'error') {
        showNotification('error', 'Serverfehler', String(data.message || 'unbekannt'));
        AvatarEmotions.error();
        setTimeout(() => AvatarEmotions.idle(), 2000);
      } else if (data.type === 'assistant_text' && data.text) {
        displayResponse(data.text);
        AvatarEmotions.speaking();
      } else if (data.type === 'final_text' && data.text) {
        displayResponse(data.text);
      } else if (data.op === 'ready') {
        console.log('ü§ù Handshake completed');
        AvatarEmotions.happy();
        setTimeout(() => AvatarEmotions.idle(), 1000);
      } else if (data.type === 'pong') {
        console.log('üèì Pong received');
      }
    }

    // UI Functions
    function setupEventHandlers() {
      // Text input handlers
      const textInput = document.getElementById('textInput');
      textInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          sendText();
        }
      });

      // Theme toggle
      const themeToggle = document.getElementById('themeToggle');
      if (themeToggle) {
        themeToggle.addEventListener('click', () => {
          const currentTheme = settings.theme;
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          selectTheme(newTheme);
          themeToggle.textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
        });

        // Set initial theme toggle icon
        themeToggle.textContent = settings.theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
      }

      // Info button
      document.getElementById('infoBtn').addEventListener('click', () => {
        showSystemInfo();
      });

      // Close sidebar when clicking outside
      document.addEventListener('click', (event) => {
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('sidebarToggle');
        
        if (sidebarOpen && !sidebar.contains(event.target) && !toggleBtn.contains(event.target)) {
          toggleSidebar();
        }
      });

      // Keyboard shortcuts
      document.addEventListener('keydown', (event) => {
        // ESC to close sidebar
        if (event.key === 'Escape' && sidebarOpen) {
          toggleSidebar();
        }
        
        // Ctrl/Cmd + , for settings
        if ((event.ctrlKey || event.metaKey) && event.key === ',') {
          event.preventDefault();
          toggleSidebar();
        }
        
        // Ctrl/Cmd + Enter for voice
        if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
          event.preventDefault();
          toggleRecording();
        }
      });

      // Auto dark mode based on time
      if (settings.autoDarkMode) {
        const hour = new Date().getHours();
        const shouldBeDark = hour < 7 || hour > 19;
        if ((shouldBeDark && settings.theme === 'light') || (!shouldBeDark && settings.theme === 'dark')) {
          selectTheme(shouldBeDark ? 'dark' : 'light');
        }
      }
    }

    function showSystemInfo() {
      const info = {
        version: '2.1.0',
        platform: navigator.platform,
        connection: ws && ws.readyState === WebSocket.OPEN ? 'Verbunden' : 'Getrennt',
        browser: navigator.userAgent.includes('Chrome') ? 'Chrome' : 'Other',
        features: 'WebSocket, MediaRecorder, WebRTC, Voice Visualization',
        theme: settings.theme,
        avatarStyle: settings.avatarStyle,
        totalQueries: usageStats.totalQueries
      };

      const infoText = `Version: ${info.version}
Platform: ${info.platform}
Verbindung: ${info.connection}
Browser: ${info.browser}
Features: ${info.features}
Theme: ${info.theme}
Avatar: ${info.avatarStyle}
Anfragen: ${info.totalQueries}`;
      
      showNotification('success', 'üìä System-Information', infoText, 8000);
    }

    function sendText() {
      const input = document.getElementById('textInput');
      if (!input.value.trim()) return;

      const userText = input.value.trim();
      input.value = '';

      if (ws && ws.readyState === WebSocket.OPEN) {
        AvatarEmotions.thinking();
        showProcessingAnimation();
        displayResponse(`Verarbeite: "${userText}"`);
        
        ws.send(JSON.stringify({ 
          type: "text", 
          content: userText,
          timestamp: Date.now()
        }));
        
        updateUsageStats('text');
      } else {
        showNotification('error', 'Keine Verbindung', 'Bitte warten Sie, bis die Verbindung hergestellt ist');
        AvatarEmotions.error();
        setTimeout(() => AvatarEmotions.idle(), 2000);
      }
    }

    function toggleRecording() {
      if (isRecording) {
        stopRecording();
      } else {
        startRecording();
      }
    }

    async function startRecording() {
      try {
        // Initialize AudioContext if not exists
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }

        const audioSettings = {
          echoCancellation: settings.echoCancellation,
          noiseSuppression: settings.noiseSuppression,
          sampleRate: 44100
        };

        const stream = await navigator.mediaDevices.getUserMedia({ audio: audioSettings });
        
        // Start voice visualization
        if (settings.voiceVisualization) {
          VoiceVisualizer.start(stream);
        }

        mediaRecorder = new MediaRecorder(stream, {
          mimeType: 'audio/webm;codecs=opus'
        });
        
        const audioChunks = [];
        
        mediaRecorder.ondataavailable = event => {
          audioChunks.push(event.data);
        };
        
        mediaRecorder.onstop = () => {
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          const reader = new FileReader();
          
          reader.onloadend = () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
              AvatarEmotions.thinking();
              showProcessingAnimation();
              displayResponse("Verarbeite Spracheingabe...");
              
              ws.send(JSON.stringify({ 
                type: "audio", 
                content: reader.result,
                timestamp: Date.now()
              }));
              
              updateUsageStats('voice');
            } else {
              showNotification('error', 'Keine Verbindung', 'Spracheingabe konnte nicht √ºbertragen werden');
              AvatarEmotions.error();
            }
          };
          
          reader.readAsDataURL(audioBlob);
          stream.getTracks().forEach(track => track.stop());
          VoiceVisualizer.stop();
        };
        
        mediaRecorder.start();
        isRecording = true;
        updateRecordingUI(true);
        AvatarEmotions.listening();
        
        recordingStartTime = Date.now();
        recordingTimer = setInterval(updateRecordingTime, 100);
        
        showNotification('success', 'Aufnahme gestartet', 'Sprechen Sie jetzt...');
        
        // Auto-stop after 30 seconds
        setTimeout(() => {
          if (isRecording) stopRecording();
        }, 30000);
        
      } catch (err) {
        showNotification('error', 'Mikrofonzugriff verweigert', 'Bitte erlauben Sie den Zugriff auf das Mikrofon');
        console.error('Microphone Error:', err);
        AvatarEmotions.error();
        setTimeout(() => AvatarEmotions.idle(), 2000);
      }
    }

    function stopRecording() {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        updateRecordingUI(false);
        clearInterval(recordingTimer);
        VoiceVisualizer.stop();
        showNotification('success', 'Aufnahme beendet', 'Wird verarbeitet...');
      }
    }

    function updateRecordingUI(recording) {
      const voiceBtn = document.getElementById('voiceBtn');
      const voiceIcon = document.getElementById('voiceIcon');
      const indicator = document.getElementById('recordingIndicator');

      if (recording) {
        voiceBtn.classList.add('recording');
        voiceIcon.textContent = '‚èπÔ∏è';
        indicator.classList.add('active');
      } else {
        voiceBtn.classList.remove('recording');
        voiceIcon.textContent = 'üé§';
        indicator.classList.remove('active');
      }
    }

    function updateRecordingTime() {
      if (recordingStartTime) {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const timeElement = document.getElementById('recordingTime');
        if (timeElement) {
          timeElement.textContent = `${elapsed}s`;
        }
      }
    }

    function displayResponse(content) {
      const responseElement = document.getElementById('responseContent');
      hideProcessingAnimation();
      
      if (!content || content === "Ihre Antwort erscheint hier...") {
        responseElement.innerHTML = '<div class="response-empty">Ihre Antwort erscheint hier...</div>';
        responseElement.classList.remove('show');
        return;
      }
      
      responseElement.innerHTML = '';
      responseElement.classList.add('show');
      
      // Matrix rain effect for responses
      matrixRain(responseElement, content);
      
      // Update session time
      updateUsageStats('time', Date.now() - usageStats.sessionStart);
      usageStats.sessionStart = Date.now();
    }

    function matrixRain(element, text) {
      const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let iteration = 0;
      
      const interval = setInterval(() => {
        element.textContent = text
          .split('')
          .map((char, index) => {
            if (index < iteration) {
              return char;
            }
            return letters[Math.floor(Math.random() * letters.length)];
          })
          .join('');
          
        if (iteration >= text.length) {
          clearInterval(interval);
          element.textContent = text;
        }
        iteration += 1;
      }, 30);
    }

    function showProcessingAnimation() {
      const animation = document.getElementById('processingAnimation');
      animation.classList.add('active');
    }

    function hideProcessingAnimation() {
      const animation = document.getElementById('processingAnimation');
      animation.classList.remove('active');
    }

    // --- Audio Playback (Data-URL / WAV/Opus) ---
    const _audioQueue = [];
    let _isPlaying = false;

    async function playDataUrlAudio(dataUrl) {
      try {
        if (typeof dataUrl !== 'string' || !dataUrl.startsWith('data:audio')) return;

        // einfache Queue, damit mehrere TTS-Segmente nacheinander laufen
        _audioQueue.push(dataUrl);
        if (_isPlaying) return;
        _isPlaying = true;  # <-- will be fixed below
      } catch (e) {
        console.warn('playDataUrlAudio: enqueue error', e);
      }
      try {
        while (_audioQueue.length) {
          const url = _audioQueue.shift();

          // schneller Weg: direkt via <audio>
          const a = new Audio(url);
          a.preload = 'auto';
          await new Promise((resolve, reject) => {
            a.onended = resolve;
            a.oncanplay = () => a.play().catch(reject);
            a.onerror = reject;
          });
        }
      } catch (err) {
        console.error('Audio playback failed:', err);
        showNotification('error', 'Audio-Fehler', 'TTS-Wiedergabe fehlgeschlagen');
      } finally {
        _isPlaying = false;
      }
    }
    



    function showNotification(type, title, message, duration = 4000) {
      if (!settings.notifications) return;
      
      const container = document.getElementById('notificationContainer');
      const notification = document.createElement('div');
      
      notification.className = `notification ${type}`;
      notification.innerHTML = `
        <div class="notification-icon">
          ${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è'}
        </div>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <div class="notification-message">${message}</div>
        </div>
        <button class="notification-close" onclick="closeNotification(this)">√ó</button>
      `;
      
      container.appendChild(notification);
      
      // Animate in
      setTimeout(() => notification.classList.add('show'), 100);
      
      // Auto remove
      setTimeout(() => {
        closeNotification(notification.querySelector('.notification-close'));
      }, duration);
    }

    function closeNotification(button) {
      const notification = button.closest('.notification');
      notification.classList.remove('show');
      setTimeout(() => notification.remove(), 400);
    }

    // Service worker registration for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(registration => {
            console.log('SW registered: ', registration);
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
      if (animationId) {
        cancelAnimationFrame(animationId);
      }
      if (audioContext) {
        audioContext.close();
      }
    });
  </script>
</body>
<!-- === TTS WAV Player ‚Äì injected === -->
<script>
(()=>{let el=document.getElementById("ttsAudioPlayer");if(!el){el=document.createElement("audio");el.id="ttsAudioPlayer";el.style.display="none";el.preload="auto";document.body.appendChild(el);}function b64ToBlob(b64){const bin=atob(b64);const u8=new Uint8Array(bin.length);for(let i=0;i<bin.length;i++)u8[i]=bin.charCodeAt(i);return new Blob([u8],{type:"audio/wav"});}function playWav(b64){try{const url=URL.createObjectURL(b64ToBlob(b64));el.src=url;el.onended=()=>URL.revokeObjectURL(url);el.play().catch(e=>{console.warn("TTS play() blocked:",e);typeof showNotification=="function"&&showNotification("error","Audio blockiert","Bitte einmal klicken, um Audio zu erlauben");});}catch(e){console.error("WAV decode failed",e);} }const orig=window.handleWebSocketMessage;window.handleWebSocketMessage=function(d){try{if(d&&d.type==="tts"&&d.format==="wav_base64"&&d.audio){playWav(d.audio);}else if(d&&d.type==="tts"&&typeof d.content==="string"&&d.content.startsWith("data:audio/")){const i=d.content.indexOf("base64,");if(i>=0)playWav(d.content.slice(i+7));}}catch(e){console.warn("TTS hook error",e);}return typeof orig=="function"?orig.call(this,d):undefined;};console.log("‚úÖ TTS WAV Player active");})();
</script>
<!-- === /TTS WAV Player === -->
</html>

<!-- === TTS WAV Player ‚Äì injected by setup === -->
<script>
(() => {
  // 1) globaler, versteckter Audio-Player
  let ttsAudioEl = document.getElementById('ttsAudioPlayer');
  if (!ttsAudioEl) {
    ttsAudioEl = document.createElement('audio');
    ttsAudioEl.id = 'ttsAudioPlayer';
    ttsAudioEl.style.display = 'none';
    ttsAudioEl.preload = 'auto';
    document.body.appendChild(ttsAudioEl);
  }

  function playBase64Wav(b64) {
    try {
      const blob = b64ToWavBlob(b64);
      const url = URL.createObjectURL(blob);
      ttsAudioEl.src = url;
      ttsAudioEl.onended = () => URL.revokeObjectURL(url);
      ttsAudioEl.play().catch(err => {
        console.warn('TTS play() failed:', err);
        if (typeof showNotification === 'function') {
          showNotification('error','Audio-Ausgabe blockiert','Bitte einmal mit der Maus klicken / Interaktion erlauben.');
        }
      });
    } catch (e) {
      console.error('WAV decode failed:', e);
      if (typeof showNotification === 'function') {
        showNotification('error','TTS-Fehler','WAV konnte nicht abgespielt werden.');
      }
    }
  }

  function b64ToWavBlob(b64) {
    // Base64 -> ArrayBuffer
    const byteStr = atob(b64);
    const len = byteStr.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) bytes[i] = byteStr.charCodeAt(i);
    return new Blob([bytes], { type: 'audio/wav' });
  }

  function tryExtractBase64FromDataUrl(dataUrl) {
    // erwartet "data:audio/wav;base64,...."
    const idx = dataUrl.indexOf('base64,');
    return idx >= 0 ? dataUrl.slice(idx + 7) : null;
  }

  // 2) vorhandene Message-Handler-Funktion sanft erweitern
  const _origHandle = window.handleWebSocketMessage;
  window.handleWebSocketMessage = function(data) {
    try {
      // Fall A: neues Backend-Format
      if (data && data.type === 'tts' && data.format === 'wav_base64' && data.audio) {
        playBase64Wav(data.audio);
      }
      // Fall B: Fallback ‚Äì data: URL in "content"
      else if (data && data.type === 'tts' && typeof data.content === 'string' && data.content.startsWith('data:audio/')) {
        const b64 = tryExtractBase64FromDataUrl(data.content);
        if (b64) playBase64Wav(b64);
      }
    } catch (e) {
      console.warn('Extended TTS handler error:', e);
    }

    // Original-Logik weiter ausf√ºhren
    if (typeof _origHandle === 'function') {
      return _origHandle.call(this, data);
    }
  };

  console.log('‚úÖ TTS WAV Player injected');
})();
</script>
<!-- === /TTS WAV Player === -->
