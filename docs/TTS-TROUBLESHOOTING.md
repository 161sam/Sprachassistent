# TTS Sanitizer & Phoneme Troubleshooting

## Pipeline Overview
1. **Text normalization** – `sanitize_for_tts` cleans input (Unicode, zero‑width, typographic fallback).
2. **Phonemization** – text converted to phoneme sequence (e.g. eSpeak‑NG/phonemizer).
3. **Phoneme→ID mapping** – symbols looked up in model `phoneme_id_map`.
4. **Synthesis** – audio generated by Piper, Zonos or Kokoro.

## Maintaining Phoneme Dictionaries
- Piper model maps live in `*.onnx.json` next to model files.
- Extend `phoneme_id_map` only with symbols the model can pronounce.
- Audit coverage with `tools/tts/phoneme_audit.py`:
  ```bash
  python tools/tts/phoneme_audit.py models/piper/de_DE-thorsten-low.onnx.json de < phrases.txt
  ```

## Sanitizer Configuration
Enable via environment variables:
```
TTS_SANITIZE_ENABLED=true
TTS_UNICODE_NORMALIZATION=NFKC  # or NFC
TTS_DROP_ORPHAN_COMBINING=true
```

### Missing phoneme from id map

The warning *"Missing phoneme from id map"* usually stems from stray
combining marks (for example the cedilla `\u0327`) or characters outside the
model's alphabet. The pre-sanitizer now normalizes text (NFKC→NFD→NFC), drops
or replaces unknown symbols (e.g. `Ł`→`L`, `đ`→`d`) and logs a warning instead
of raising an error. Feeding texts like `façade`, `garçon`, `çedilla`,
`übermäßig`, `Łódź`, `İstanbul` or `naïve` no longer produces this warning.

## Fallback Strategy
Unknown phonemes are dropped or mapped once per symbol with a warning. Logs stay readable and synthesis continues.

## Performance & Rollback
Sanitizing adds negligible overhead (<1µs/character). Disable by setting `TTS_SANITIZE_ENABLED=false` if problems occur.
