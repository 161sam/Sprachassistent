# TTS Sanitizer & Phoneme Troubleshooting

## Pipeline Overview
1. **Text normalization** – `sanitize_for_tts` cleans input (Unicode, zero‑width, typographic fallback).
2. **Phonemization** – text converted to phoneme sequence (e.g. eSpeak‑NG/phonemizer).
3. **Phoneme→ID mapping** – symbols looked up in model `phoneme_id_map`.
4. **Synthesis** – audio generated by Piper, Zonos or Kokoro.

## Maintaining Phoneme Dictionaries
- Piper model maps live in `*.onnx.json` next to model files.
- Extend `phoneme_id_map` only with symbols the model can pronounce.
- Audit coverage with `tools/tts/phoneme_audit.py`:
  ```bash
  python tools/tts/phoneme_audit.py models/piper/de_DE-thorsten-low.onnx.json de < phrases.txt
  ```

## Sanitizer Configuration
Enable via environment variables:
```
TTS_SANITIZE_ENABLED=true
TTS_UNICODE_NORMALIZATION=NFKC  # or NFC
TTS_DROP_ORPHAN_COMBINING=true
```

### Missing phoneme from id map

The warning *"Missing phoneme from id map"* usually stems from stray
combining marks (for example the cedilla `\u0327`) or characters outside the
model's alphabet. The helper `pre_sanitize_text()` normalizes
text (NFKC→NFD→NFC), removes combining marks, and maps or drops unknown
symbols (e.g. `Ł`→`L`, `đ`→`d`). Unsupported ASCII symbols like `%` or `$`
are stripped as well. Every removal triggers a warning instead of raising an
error. Feeding texts like `façade`, `garçon`, `çedilla`, `übermäßig`,
`Łódź`, `İstanbul` or `naïve` no longer produces this warning.

## Fallback Strategy
Unknown phonemes are dropped or mapped once per symbol with a warning. Logs stay readable and synthesis continues.

## Performance & Rollback
Sanitizing adds negligible overhead (<1µs/character). Disable by setting `TTS_SANITIZE_ENABLED=false` if problems occur.

## Piper model not found
If startup logs show `Kein Piper-Modell gefunden`, the engine could not
locate the ONNX model.  Verify the alias and model paths:

```bash
ls -l models/piper
```

Symlinks like `de-thorsten-low.onnx -> de_DE-thorsten-low.onnx` must point to
the real file next to a `*.onnx.json` metadata file.

Neue, robuste Auflösung (kein „default.onnx“ mehr):
- Standard‑Suchpfad: `PIPER_MODELS_DIR` (Default: `models/piper`)
- Priorität ohne gesetzte Stimme: `de-thorsten-low` > `de-thorsten-high` > erstes `de-*.onnx` > erstes `*.onnx` im Verzeichnis
- Bei fehlendem Sidecar: Thorsten‑Modelle → 22050 Hz

Empfohlene ENV‑Defaults (env.example):
```
PIPER_MODELS_DIR=models/piper
PIPER_DEFAULT_VOICE=de-thorsten-low
```

Fehlermeldung „Kein Piper‑Modell gefunden …“ bedeutet, dass im Pfad kein `.onnx`
liegt oder der Alias nicht existiert. Lege Modelle in `models/piper/` ab oder
setze `PIPER_MODELS_DIR` entsprechend.

## Piper Modellpfad doppelt geprefixt

Erscheint im Log ein Pfad wie `models/models/piper/...`, ist der
`model_path` bereits relativ zu `TTS_MODEL_DIR` angegeben.

Checkliste:

1. In `config/tts.json` darf `model_path` nur einmal relativ zum
   Modellspeicher angegeben sein.
2. Wenn `TTS_MODEL_DIR` gesetzt ist, kein weiteres `models/` voranstellen.
3. Alternativ einen absoluten Pfad zum Modell verwenden.
## Zonos hat keine Stimme (thorsten)

- Stelle sicher, dass die Stimme in `config/tts.json` gemappt ist:
  - `voice_map.de-thorsten-low.zonos.voice_id = "thorsten"`
- Lege ein Sprecher‑Sample in `spk_cache/` ab, z. B.: `spk_cache/thorsten.wav` (MP3/FLAC/OGG/M4A werden ebenfalls erkannt, Groß/Kleinschreibung egal).
- Optional: Vorberechnetes Embedding: `spk_cache/thorsten.pt` (wird automatisch erzeugt, wenn ein Audio‑Sample vorhanden ist).
- Ohne Sample verwendet Zonos die Default‑Stimme und protokolliert eine Warnung; die Synthese läuft weiter.

Lokales Modell (optional):

- Pfad via `ZONOS_LOCAL_DIR` setzen (Ordner mit `config.json` und `model.safetensors`), sonst nutzt die Engine `ZONOS_MODEL_ID` (z. B. `Zyphra/Zonos-v0.1-transformer`).


### Zonos Sprache
- Aliasse werden normalisiert (alle Fälle → Kleinbuchstaben):
  - de-de, de_DE, de-DE, de-DEU, deu, ger → de
  - en-us, eng → en
  - fr-fr → fr
  - zh-cn → zh; „chinese“ → zh; „japanese“ → ja
- Fallback, wenn nichts gesetzt: `ZONOS_LANG_DEFAULT` (Default: `de`)

Fehlermeldung bei Nicht‑Unterstützung ist jetzt ausführlich und nennt gültige Optionen.

Empfohlener Default (env.example):
```
ZONOS_LANG_DEFAULT=de
```

- Piper Default Voice
  - Setze `TTS_DEFAULT_VOICE` (z. B. `de-thorsten-low`) oder konfiguriere Voice Aliases in `docs/TTS-VOICE-ALIASES.md`.
  - Der Intro-Teil nutzt niemals `default`, sondern eine auflösbare Alias-Stimme.

## WebSocket set_tts_options Fehler
Ursache: In einigen Umgebungen führte ein ungebundenes `asyncio` im Handler zu
`UnboundLocalError: cannot access local variable 'asyncio'`.

Fix: Der Handler speichert Optionen rein synchron in einem lokalen State und
antwortet mit:
```
{"type":"ok","action":"set_tts_options"}
```
Die Werte werden protokolliert („TTS‑Optionen aktualisiert …“). Engine‑seitige
Effekte bleiben davon entkoppelt.
